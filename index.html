<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FERJO Catálogo</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Favicon / App Icons -->
  <link rel="icon" href="Logotipo_0.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="Logotipo_0.png">
  <link rel="apple-touch-icon" href="Logotipo_0.png">
  <meta name="theme-color" content="#111111">


  <!-- Estilos mínimos del modal "Solicitar" -->
  <style>
    :root{
      color-scheme: dark;
    }
    body{background:#0b0b0b;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:16px 20px;background:#0f0f0f;border-bottom:1px solid #1c1c1c}
    header h1{margin:0;font-size:20px}
    .controls{display:flex;gap:10px}
    .controls input,.controls select{
      background:#101010;border:1px solid #222;color:#eee;border-radius:10px;padding:10px 12px;min-width:240px
    }

    main#grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;padding:16px}

    .card{background:#111;border:1px solid #1e1e1e;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .card .img{position:relative;background:#090909}
    .card .img img{display:block;width:100%;height:220px;object-fit:contain;background:#00000020}
    .card .img .nav{position:absolute;top:50%;transform:translateY(-50%);border:none;background:#00000066;color:#fff;font-size:22px;width:32px;height:38px;border-radius:10px;cursor:pointer}
    .card .img .prev{left:6px}
    .card .img .next{right:6px}
    .card .img .dots{position:absolute;bottom:6px;left:0;right:0;display:flex;justify-content:center;gap:6px}
    .card .img .dots span{width:6px;height:6px;border-radius:999px;background:#ffffff45}
    .card .img .dots span.active{background:#fff}
    .card .info{padding:12px}
    .card .name{font-size:16px;margin:0 0 6px}
    .card .sku,.card .stock{opacity:.8;margin:4px 0}
    .card .price{font-weight:600;margin:4px 0 10px}
    .card .btn{width:100%;background:#2563eb;border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.open{display:flex}
    .modal-content{background:#111;color:#fff;border-radius:14px;padding:20px;max-width:560px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modal h3{margin:0 0 10px 0}
    .modal form label{display:block;margin:8px 0 4px}
    .modal form input,.modal form textarea,.modal form select{
      width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#0c0c0c;color:#f2f2f2
    }
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn-primary{background:#2563eb;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn-secondary{background:#222;color:#ddd;border:1px solid #333;padding:10px 14px;border-radius:10px;cursor:pointer}
    .prod-preview{display:flex;gap:12px;align-items:center;margin:8px 0 12px}
    .prod-preview img{max-height:120px;object-fit:contain;border-radius:8px;background:#00000020}
    .prod-preview .name{font-weight:600}
    .prod-preview .sku{font-size:.9em;opacity:.8}
    .msg{margin-top:8px;font-size:.92em}
  </style>
</head>
<body>
  <header>
    <div class="brand-wrap">
      <img src="Logotipo_0.png" alt="FERJO" class="brand-logo">
      <h1>Catálogo FERJO</h1>
    </div>
    <div class="controls">
      <button id="themeToggle" class="btn" style="margin-left:auto">Tema</button>
      <button id="cartBtn" class="btn" type="button">Carrito (0)</button>
      <input id="search" placeholder="Buscar por nombre o código..." />
      <select id="category">
        <option value="">Todas las categorías</option>
      </select>
    </div>
  </header>

  <main id="grid"></main>

  <!-- Plantilla de tarjeta con carrusel -->
  <template id="card-tpl">
    <article class="card">
      <div class="img">
        <img alt="">
        <button class="nav prev" aria-label="Anterior">‹</button>
        <button class="nav next" aria-label="Siguiente">›</button>
        <div class="dots"></div>
      </div>
      <div class="info">
        <h2 class="name"></h2>
        <p class="sku"></p>
        <p class="price"></p>
        <p class="stock"></p>
        <button class="btn btn-add-cart" type="button">Agregar al carrito</button>
      </div>
    </article>
  </template>

    <!-- Modal "Carrito / Solicitar" -->
  <div id="solicitarModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="solicitarTitle">
    <div class="modal-content">
      <h3 id="solicitarTitle">Tu pedido</h3>

      <!-- Aquí se pinta el contenido del carrito -->
      <div id="cartItems" class="cart-items"></div>

      <form id="solicitarForm" novalidate>
        <!-- Campos del cliente -->
        <label for="nombre_cliente">Nombre completo*</label>
        <input id="nombre_cliente" name="nombre_cliente" required>

        <label for="telefono">Teléfono (GT)*</label>
        <input id="telefono" name="telefono" required placeholder="502XXXXXXXX o 8 dígitos">

        <label for="email">Email (opcional)</label>
        <input id="email" name="email" type="email" placeholder="cliente@correo.com">

        <label for="sucursal_envio">Entrega/Envío (Sucursal o dirección - opcional)</label>
        <input id="sucursal_envio" name="sucursal_envio" placeholder="Sucursal central / Dirección para envío">

        <label for="notas">Notas (opcional)</label>
        <textarea id="notas" name="notas" rows="3" placeholder="Aclaraciones, horario preferido, etc."></textarea>

        <!-- Honeypot anti-bots -->
        <div style="position:absolute;left:-9999px;" aria-hidden="true">
          <label>Tu mes favorito <input name="favorite_month" tabindex="-1"></label>
        </div>

        <div class="actions">
          <button type="button" class="btn-secondary" id="btnCancelarSolicitar">Cancelar</button>
          <button type="submit" class="btn-primary">Enviar pedido</button>
        </div>

        <div id="solicitarMsg" class="msg" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- Tu config con la base de API -->
  <script src="config.js"></script>
  <!-- Tu app que pinta el grid/carrusel -->
  <script src="app.js"></script>

  <!-- JS mínimo para el flujo "Solicitar" -->
    <!-- JS para carrito y envío de pedido -->
  <script>
    // --- Estado global del carrito ---
    let CART = [];

    // Base de API (igual que en app.js)
    function apiBase(){
      const saved = localStorage.getItem('FERJO_API_BASE') || (window.CONFIG && window.CONFIG.API) || '';
      return (saved || '').replace(/\/+$/,'');
    }

    function validPhoneGT(tel){
      const digits = (tel || '').replace(/[^\d]/g,'');
      return /^502?\d{8}$/.test(digits) || /^\d{8}$/.test(digits);
    }

    // Actualiza texto y estado del botón Carrito
    function updateCartBadge(){
      const btn = document.getElementById('cartBtn');
      if (!btn) return;
      const totalItems = CART.reduce((sum, it)=> sum + (it.qty || 0), 0);
      btn.textContent = `Carrito (${totalItems})`;
      btn.disabled = totalItems === 0;
    }

    // Mensaje cortito debajo del formulario / modal
    function showCartHint(text){
      const msg = document.getElementById('solicitarMsg');
      if (!msg) return;
      msg.textContent = text;
      msg.style.color = '#bbb';
      setTimeout(()=>{
        if (msg.textContent === text) msg.textContent = '';
      }, 2000);
    }

    // Agregar un producto al carrito a partir de la tarjeta
    function addToCartFromCard(card){
      const nameEl  = card.querySelector('.name');
      const skuEl   = card.querySelector('.sku');
      const priceEl = card.querySelector('.price');
      const imgEl   = card.querySelector('.img img');

      const nombre = nameEl ? nameEl.textContent.trim() : '';
      const skuText = skuEl ? skuEl.textContent.trim() : '';

      // Acepta "SKU: 123" o "Código: 123"
      let sku = '';
      const m = skuText.match(/(?:sku|c[oó]digo)\s*:\s*(.+)$/i);
      sku = m ? m[1].trim() : skuText.trim();

      const priceText = priceEl ? priceEl.textContent : '';
      const priceNum = Number(
        (priceText.replace(/[^\d.,]/g,'').replace(',','.')) || 0
      );

      const image_url = (imgEl && imgEl.getAttribute('src')) ? imgEl.getAttribute('src') : '';

      if (!sku) return;

      const existing = CART.find(it => it.sku === sku);
      if (existing){
        existing.qty += 1;
      } else {
        CART.push({
          sku,
          nombre,
          precio: priceNum,
          qty: 1,
          image_url
        });
      }
      updateCartBadge();
      showCartHint((nombre || 'Producto') + ' agregado al carrito.');
    }

    // Renderiza el carrito dentro del modal
    function renderCartModal(){
      const box = document.getElementById('cartItems');
      if (!box) return;

      if (!CART.length){
        box.innerHTML = '<p class="cart-empty">Tu carrito está vacío.</p>';
        return;
      }

      let filas = '';
      CART.forEach((it, idx)=>{
        const subtotal = (it.precio || 0) * (it.qty || 0);
        const img = it.image_url
          ? `<img src="${it.image_url}" alt="" style="width:40px;height:40px;object-fit:contain;border-radius:6px;background:#00000020;margin-right:6px;">`
          : '';
        filas += `
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                ${img}
                <div>
                  <div>${it.nombre || ''}</div>
                  <div style="font-size:.8em;opacity:.8;">SKU: ${it.sku}</div>
                </div>
              </div>
            </td>
            <td class="qty-cell">
              <input type="number" min="1" value="${it.qty}" onchange="updateCartQty(${idx}, this.value)">
            </td>
            <td style="text-align:right;">Q ${(it.precio || 0).toFixed(2)}</td>
            <td style="text-align:right;">Q ${subtotal.toFixed(2)}</td>
            <td style="text-align:center;">
              <button type="button" class="btn-secondary" onclick="removeFromCart(${idx})">×</button>
            </td>
          </tr>
        `;
      });

      const total = CART.reduce((s,it)=> s + (it.precio || 0) * (it.qty || 0), 0);

      box.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${filas}</tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;"><b>Total estimado</b></td>
              <td style="text-align:right;"><b>Q ${total.toFixed(2)}</b></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      `;
    }

    // Actualizar cantidad desde el input del carrito
    function updateCartQty(index, value){
      let n = Number(value);
      if (!isFinite(n) || n <= 0) n = 1;
      if (!CART[index]) return;
      CART[index].qty = n;
      renderCartModal();
      updateCartBadge();
    }

    // Quitar línea del carrito
    function removeFromCart(index){
      CART.splice(index, 1);
      renderCartModal();
      updateCartBadge();
    }

    // Abrir / cerrar modal
    function openCartModal(){
      const m = document.getElementById('solicitarModal');
      const msg = document.getElementById('solicitarMsg');
      if (msg){
        msg.textContent = '';
        msg.style.color = '#bbb';
      }
      renderCartModal();
      m.classList.add('open');
    }

    function closeSolicitarModal(){
      document.getElementById('solicitarModal').classList.remove('open');
    }

    // Delegación: click en "Agregar al carrito" en cualquier tarjeta
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('.btn-add-cart');
      if (!btn) return;
      const card = btn.closest('.card');
      if (!card) return;
      addToCartFromCard(card);
    });

    // Abrir carrito al pulsar el botón del header
    document.getElementById('cartBtn')?.addEventListener('click', ()=>{
      openCartModal();
    });

    // Cerrar modal
    document.getElementById('btnCancelarSolicitar').addEventListener('click', closeSolicitarModal);
    document.getElementById('solicitarModal').addEventListener('click', (e)=>{
      if (e.target.id === 'solicitarModal') closeSolicitarModal();
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') closeSolicitarModal();
    });

    // Submit del formulario → envía TODO el carrito
    document.getElementById('solicitarForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const f = ev.target;
      const msg = document.getElementById('solicitarMsg');
      msg.textContent = '';
      msg.style.color = '#bbb';

      // Honeypot
      if (f.favorite_month && f.favorite_month.value){
        msg.textContent = 'Error al validar el formulario.';
        msg.style.color = '#f88';
        return;
      }

      if (!CART.length){
        msg.textContent = 'Tu carrito está vacío.';
        msg.style.color = '#f88';
        return;
      }

      if (!f.nombre_cliente.value.trim()){
        msg.textContent = 'Ingresa tu nombre.';
        msg.style.color = '#f88';
        document.getElementById('nombre_cliente').focus();
        return;
      }
      if (!validPhoneGT(f.telefono.value)){
        msg.textContent = 'Teléfono de Guatemala inválido.';
        msg.style.color = '#f88';
        document.getElementById('telefono').focus();
        return;
      }
      if (f.email.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email.value)){
        msg.textContent = 'Correo inválido.';
        msg.style.color = '#f88';
        document.getElementById('email').focus();
        return;
      }

      const payload = {
        items: CART.map(it => ({
          sku: it.sku,
          nombre_producto: it.nombre,
          qty: it.qty,
          precio: it.precio
        })),
        nombre_cliente: f.nombre_cliente.value.trim(),
        telefono: f.telefono.value.trim(),
        email: (f.email.value || '').trim(),
        sucursal_envio: (f.sucursal_envio.value || '').trim(),
        notas: (f.notas.value || '').trim(),
        canal: 'web'
      };

      const controls = [...f.elements];
      controls.forEach(el=> el.disabled = true);
      msg.textContent = 'Enviando...';

      try{
        const base = apiBase();
        if (!base) throw new Error('Configura FERJO_API_BASE en el Admin.');
        const url = base + (base.includes('?') ? '&' : '?') + 'path=catalog_cart';

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain; charset=utf-8' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({ ok:false, error:'Respuesta no válida' }));
        if (!res.ok || !data.ok){
          throw new Error(data.error || ('HTTP ' + res.status));
        }

        msg.textContent = '¡Listo! Hemos recibido tu pedido. Te contactaremos en breve.';
        msg.style.color = '#8f8';

        // Limpia carrito
        CART = [];
        updateCartBadge();
        renderCartModal();

        setTimeout(()=>{ closeSolicitarModal(); }, 1200);

      }catch(err){
        msg.textContent = 'Error: ' + err.message;
        msg.style.color = '#f88';
      }finally{
        controls.forEach(el=> el.disabled = false);
      }
    });

    // Inicializa badge en 0
    updateCartBadge();
  </script>

  <script>
  // Aplica preferencia guardada (si existe)
  (function(){
    const saved = localStorage.getItem('FERJO_THEME'); // 'light' | 'dark' | null
    if (saved === 'light' || saved === 'dark') {
      document.documentElement.setAttribute('data-theme', saved);
    }
  })();

  // Alternar y persistir
  document.getElementById('themeToggle')?.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('FERJO_THEME', next);
  });
</script>

</body>
</html>
